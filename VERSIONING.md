# Slunsecore Versioning

## Overview

This document describes how versioning works in Slunsecore, including version string format, filename conventions, and how versions are embedded in firmware.

## Version String Format

Slunsecore firmware versions are identified with a "slunse-" prefix to distinguish them from standard MeshCore builds.

### Format

- **Pattern**: `slunse-{VERSION}-{COMMIT_HASH}`
- **Tag builds**: `slunse-v1.2.3-8f637c1`
- **Branch builds**: `slunse-20240115-143022-a1b2c3d`

### Components

1. **Prefix**: `slunse-` - Identifies this as a Slunsecore build
2. **Version**: The semantic version (e.g., `v1.2.3`) or date-based version for branch builds
3. **Commit Hash**: Short git commit SHA (7 characters) for traceability

### Where Version Appears

The version string is embedded in the firmware binary at compile time and appears in:

- **Boot screen**: Version displayed (commit hash stripped for readability)
  - Shows: `slunse-v1.2.3`
- **Serial/BLE "ver" command**: Full version with build date
  - Shows: `slunse-v1.2.3-8f637c1 (Build: 15-Jan-2024)`
- **Device info packets**: Sent to connected apps
  - Contains: `slunse-v1.2.3-8f637c1`

## Filename Convention

Built firmware files follow different naming patterns depending on the build type:

### Official Release Builds

Built from `slunsecore` branch (automatic pushes or tag-based releases):

**Format:**
```
{TARGET}-slunse-{VERSION}-{COMMIT_HASH}.{ext}
```

**Examples:**
- `RAK_4631_companion_radio_usb-slunse-v1.2.3-8f637c1.bin`
- `Heltec_v3_repeater-slunse-v1.2.3-8f637c1.uf2`
- `RAK_4631_room_server-slunse-v1.2.3-8f637c1.zip`

### Nightly Builds

Built from `dev-slunsecore` branch (manual triggers):

**Format:**
```
nightly-{TARGET}-slunse-{VERSION}-{COMMIT_HASH}.{ext}
```

**Examples:**
- `nightly-RAK_4631_companion_radio_usb-slunse-v1.2.3-8f637c1.bin`
- `nightly-Heltec_v3_repeater-slunse-v1.2.3-8f637c1.uf2`
- `nightly-RAK_4631_room_server-slunse-v1.2.3-8f637c1.zip`

The `nightly-` prefix clearly distinguishes development/nightly builds from official release builds.

### File Extensions

- `.bin` - ESP32 firmware (standard)
- `.bin` with `-merged` suffix - ESP32 merged firmware for fresh installs
- `.uf2` - nRF52 firmware (UF2 format)
- `.zip` - nRF52 firmware (ZIP format)

## Tag Naming Convention

This section describes the technical specification for release tags. For the release process, see [RELEASE.md](RELEASE.md).

### Format

```
slunsecore-{TYPE}-v{VERSION}
```

### Types

- `companion` - Companion radio firmwares
- `repeater` - Repeater firmwares
- `room-server` - Room server firmwares

### Examples

- `slunsecore-companion-v1.2.3`
- `slunsecore-repeater-v1.2.3`
- `slunsecore-room-server-v1.2.3`

### Processing Flow

1. Tag is created: `slunsecore-companion-v1.2.3`
2. GitHub Actions extracts version: `v1.2.3` (everything after last dash)
3. Build script adds prefix: `slunse-v1.2.3-{COMMIT_HASH}`
4. Firmware files are built with version embedded

## Build Date

Build date is automatically generated during compilation:

- **Format**: `DD-MMM-YYYY` (e.g., `15-Jan-2024`)
- **Source**: Generated by `build.sh` using `date '+%d-%b-%Y'`
- **Display**: Shown on boot screen below version number
- **Storage**: Embedded in firmware binary as `FIRMWARE_BUILD_DATE` define

## Version Extraction

### From Tags

GitHub Actions extracts the version from tag names:

```bash
# Tag: slunsecore-companion-v1.2.3
# Extracted: v1.2.3 (everything after last dash)
GIT_TAG_VERSION="${GIT_TAG_NAME##*-}"
```

### From Branch Builds

For branch pushes (non-tagged builds):

```bash
# Format: YYYYMMDD-HHMMSS-commitSHA
# Example: 20240115-143022-a1b2c3d
BUILD_DATE=$(date +%Y%m%d-%H%M%S)
GIT_COMMIT_VERSION="${BUILD_DATE}-${GIT_COMMIT_SHORT}"
```

## Version Storage

The firmware version is **NOT** stored in device memory (EEPROM/NVS/flash). Instead:

- Version is **compiled into the firmware binary** at build time
- Available at runtime via `FIRMWARE_VERSION` macro
- No separate storage needed - it's part of the binary itself

## Compatibility

- Version format is compatible with MeshCore's version handling
- The "slunse-" prefix is added transparently in the build process
- Apps and tools that parse versions will see the full string including prefix
- Version extraction in GitHub Actions is independent of the prefix
