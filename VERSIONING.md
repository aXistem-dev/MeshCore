# Slunsecore Versioning

## Overview

This document describes how versioning works in Slunsecore, including version string format, filename conventions, and how versions are embedded in firmware.

## Version String Format

Slunsecore firmware versions are identified with a "sc-" prefix (short for slunsecore) to distinguish them from standard MeshCore builds.

### Format

- **Tag builds**: `sc-v1.2.3` (no commit hash)
- **Branch builds**: `sc-v1.2.3-dev-a1b2c3d` (version with dev- prefix before commit hash)

### Components

1. **Prefix**: `sc-` - Identifies this as a Slunsecore build
2. **Version**: The semantic version (e.g., `v1.2.3`)
3. **Dev identifier**: For branch builds, `-dev-` prefix before commit hash
4. **Commit Hash**: Short git commit SHA (7 characters) for traceability (branch builds only)

### Where Version Appears

The version string is embedded in the firmware binary at compile time and appears in:

- **Boot screen**: Version displayed
  - Tag builds: `sc-v1.2.3`
  - Branch builds: `sc-v1.2.3-dev-a1b2c3d`
- **Serial/BLE "ver" command**: Full version with build date
  - Tag builds: `sc-v1.2.3 (Build: 15-Jan-2024)`
  - Branch builds: `sc-v1.2.3-dev-a1b2c3d (Build: 15-Jan-2024)`
- **Device info packets**: Sent to connected apps
  - Contains full version string as shown above

## Filename Convention

Built firmware files follow different naming patterns depending on the build type:

### Official Release Builds

Built from `slunsecore` branch (automatic pushes or tag-based releases):

**Format:**
```
{TARGET}-sc-{VERSION}.{ext}
```

**Examples:**
- `RAK_4631_companion_radio_usb-sc-v1.2.3.bin`
- `Heltec_v3_repeater-sc-v1.2.3.uf2`
- `RAK_4631_room_server-sc-v1.2.3.zip`

### Nightly Builds

Built from `dev-slunsecore` branch (manual triggers):

**Format:**
```
nightly-{TARGET}-sc-{VERSION}-dev-{COMMIT_HASH}.{ext}
```

**Examples:**
- `nightly-RAK_4631_companion_radio_usb-sc-v1.2.3-dev-a1b2c3d.bin`
- `nightly-Heltec_v3_repeater-sc-v1.2.3-dev-a1b2c3d.uf2`
- `nightly-RAK_4631_room_server-sc-v1.2.3-dev-a1b2c3d.zip`

The `nightly-` prefix clearly distinguishes development/nightly builds from official release builds.

### File Extensions

- `.bin` - ESP32 firmware (standard)
- `.bin` with `-merged` suffix - ESP32 merged firmware for fresh installs
- `.uf2` - nRF52 firmware (UF2 format)
- `.zip` - nRF52 firmware (ZIP format)

## Tag Naming Convention

This section describes the technical specification for release tags. For the release process, see [RELEASE.md](RELEASE.md).

### Format

```
sc-{TYPE}-v{VERSION}
```

### Types

- `companion` - Companion radio firmwares
- `repeater` - Repeater firmwares
- `room-server` - Room server firmwares

### Examples

- `sc-companion-v1.2.3`
- `sc-repeater-v1.2.3`
- `sc-room-server-v1.2.3`

### Processing Flow

1. Tag is created: `sc-companion-v1.2.3`
2. GitHub Actions extracts version: `v1.2.3` (everything after last dash)
3. Build script adds prefix: `sc-v1.2.3` (no commit hash for tag builds)
4. Firmware files are built with version embedded

## Build Date

Build date is automatically generated during compilation:

- **Format**: `DD-MMM-YYYY` (e.g., `15-Jan-2024`)
- **Source**: Generated by `build.sh` using `date '+%d-%b-%Y'`
- **Display**: Shown on boot screen below version number
- **Storage**: Embedded in firmware binary as `FIRMWARE_BUILD_DATE` define

## Version Extraction

### From Tags

GitHub Actions extracts the version from tag names:

```bash
# Tag: sc-companion-v1.2.3
# Extracted: v1.2.3 (everything after last dash)
GIT_TAG_VERSION="${GIT_TAG_NAME##*-}"
```

### From Branch Builds

For branch pushes (non-tagged builds), the version is extracted from the latest tag:

```bash
# Get latest tag matching sc-*-v* pattern
LATEST_TAG=$(git describe --tags --match "sc-*-v*" --abbrev=0)
# Extract version: v1.2.3 (everything after last dash)
GIT_COMMIT_VERSION="${LATEST_TAG##*-}"
# Build script adds: sc-${VERSION}-dev-${COMMIT_HASH}
# Example: sc-v1.2.3-dev-a1b2c3d
```

## Version Storage

The firmware version is **NOT** stored in device memory (EEPROM/NVS/flash). Instead:

- Version is **compiled into the firmware binary** at build time
- Available at runtime via `FIRMWARE_VERSION` macro
- No separate storage needed - it's part of the binary itself

## Compatibility

- Version format is compatible with MeshCore's version handling
- The "sc-" prefix is added transparently in the build process
- Apps and tools that parse versions will see the full string including prefix
- Version extraction in GitHub Actions is independent of the prefix
- Branch builds use the latest version tag to ensure consistency with release versions
