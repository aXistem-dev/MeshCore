# Slunsecore Versioning

## Overview

This document describes how versioning works in Slunsecore, including version string format, filename conventions, and how versions are embedded in firmware.

## Version String Format

Slunsecore firmware versions use a simplified format that distinguishes between official and development builds.

### Format

- **Official builds** (tag or `slunsecore` branch): `v1.2.3-sc-commithash`
- **Dev builds** (`dev-slunsecore` branch): `v1.2.3-scdev-commithash`

### Components

1. **Version**: The semantic version (e.g., `v1.2.3`)
2. **Build identifier**: 
   - `-sc-` for official builds (tag or `slunsecore` branch)
   - `-scdev-` for development builds (`dev-slunsecore` branch)
3. **Commit Hash**: Short git commit SHA (7 characters) for traceability

### Where Version Appears

The version string is embedded in the firmware binary at compile time and appears in:

- **Boot screen**: Simplified version displayed
  - Official builds: `v1.2.3` (commit hash stripped)
  - Dev builds: `v1.2.3-dev` (commit hash stripped, `-dev` suffix added)
- **Companion firmware app/device info**: Full version with commit hash
  - Official builds: `v1.2.3-sc-commithash`
  - Dev builds: `v1.2.3-scdev-commithash`
- **Serial/BLE "ver" command**: Full version with build date
  - Official builds: `v1.2.3-sc-commithash (Build: 15-Jan-2024)`
  - Dev builds: `v1.2.3-scdev-commithash (Build: 15-Jan-2024)`

## Filename Convention

Built firmware files follow different naming patterns depending on the build type:

### Official Release Builds

Built from `slunsecore` branch (automatic pushes or tag-based releases):

**Format:**
```
{TARGET}-{VERSION}-sc-{COMMIT_HASH}.{ext}
```

**Examples:**
- `RAK_4631_companion_radio_usb-v1.2.3-sc-a1b2c3d.bin`
- `Heltec_v3_repeater-v1.2.3-sc-a1b2c3d.uf2`
- `RAK_4631_room_server-v1.2.3-sc-a1b2c3d.zip`

### Nightly Builds

Built from `dev-slunsecore` branch (manual triggers):

**Format:**
```
nightly-{TARGET}-{VERSION}-scdev-{COMMIT_HASH}.{ext}
```

**Examples:**
- `nightly-RAK_4631_companion_radio_usb-v1.2.3-scdev-a1b2c3d.bin`
- `nightly-Heltec_v3_repeater-v1.2.3-scdev-a1b2c3d.uf2`
- `nightly-RAK_4631_room_server-v1.2.3-scdev-a1b2c3d.zip`

The `nightly-` prefix clearly distinguishes development/nightly builds from official release builds.

### File Extensions

- `.bin` - ESP32 firmware (standard)
- `.bin` with `-merged` suffix - ESP32 merged firmware for fresh installs
- `.uf2` - nRF52 firmware (UF2 format)
- `.zip` - nRF52 firmware (ZIP format)

## Tag Naming Convention

This section describes the technical specification for release tags. For the release process, see [RELEASE.md](RELEASE.md).

### Format

```
sc-{TYPE}-v{VERSION}
```

### Types

- `companion` - Companion radio firmwares
- `repeater` - Repeater firmwares
- `room-server` - Room server firmwares

### Examples

- `sc-companion-v1.2.3`
- `sc-repeater-v1.2.3`
- `sc-room-server-v1.2.3`

### Processing Flow

1. Tag is created: `sc-companion-v1.2.3`
2. GitHub Actions extracts version: `v1.2.3` (everything after last dash)
3. Build script creates version string: `v1.2.3-sc-commithash` (includes commit hash for traceability)
4. Firmware files are built with version embedded

## Build Date

Build date is automatically generated during compilation:

- **Format**: `DD-MMM-YYYY` (e.g., `15-Jan-2024`)
- **Source**: Generated by `build.sh` using `date '+%d-%b-%Y'`
- **Display**: Shown on boot screen below version number
- **Storage**: Embedded in firmware binary as `FIRMWARE_BUILD_DATE` define

## Version Extraction

### From Tags

GitHub Actions extracts the version from tag names:

```bash
# Tag: sc-companion-v1.2.3
# Extracted: v1.2.3 (everything after last dash)
GIT_TAG_VERSION="${GIT_TAG_NAME##*-}"
```

### From Branch Builds

For branch pushes (non-tagged builds), the version is extracted from the latest tag:

```bash
# Get latest tag matching sc-*-v* pattern
LATEST_TAG=$(git describe --tags --match "sc-*-v*" --abbrev=0)
# Extract version: v1.2.3 (everything after last dash)
GIT_COMMIT_VERSION="${LATEST_TAG##*-}"
# Build script creates version string based on branch:
# - slunsecore branch: ${VERSION}-sc-${COMMIT_HASH}
#   Example: v1.2.3-sc-a1b2c3d
# - dev-slunsecore branch: ${VERSION}-scdev-${COMMIT_HASH}
#   Example: v1.2.3-scdev-a1b2c3d
```

## Version Storage

The firmware version is **NOT** stored in device memory (EEPROM/NVS/flash). Instead:

- Version is **compiled into the firmware binary** at build time
- Available at runtime via `FIRMWARE_VERSION` macro
- No separate storage needed - it's part of the binary itself

## Compatibility

- Version format is compatible with MeshCore's version handling
- The build identifier (`-sc-` or `-scdev-`) is added transparently in the build process
- Apps and tools that parse versions will see the full string including build identifier and commit hash
- Version extraction in GitHub Actions is independent of the build identifier
- Branch builds use the latest version tag to ensure consistency with release versions
- Boot screen displays simplified version for better readability
